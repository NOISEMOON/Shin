<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail</title>
    <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
</head>

<body>
    <h1><a id="post-title" href="/"></a></h1>
    <div id="loading">Loading...</div>
    <div id="post-content" style="display: none;">
        <div id="news-container"></div>
    </div>
    <div id="back"><a href="/">‚Ü©Ô∏è Back</a></div>

    <script>
        const postId = getPostIdFromUrl();

        document.addEventListener("DOMContentLoaded", function () {
            fetch(`/get_detail?id=${postId}`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById("loading").innerText = "‚ùå " + data.error;
                        return;
                    }

                    document.getElementById("loading").style.display = "none";
                    document.getElementById("post-content").style.display = "block";

                    // ÊòæÁ§∫ post Êï∞ÊçÆ
                    document.getElementById("post-title").innerText = data.title;

                    const parsedContent = JSON.parse(data.content);
                    console.log("data.content: " + data.content);

                    // Ëé∑ÂèñÊñ∞ÈóªÂÆπÂô®
                    const newsContainer = document.getElementById('news-container');

                    // ÈÅçÂéÜËß£ÊûêÂêéÁöÑÂØπË±°
                    for (const newsCategory in parsedContent) {
                        console.log("newsCategory: " + newsCategory);
                        // ÂàõÂª∫ h2 ÂÖÉÁ¥†
                        const h2 = document.createElement('h2');
                        h2.innerText = newsCategory;
                        newsContainer.appendChild(h2);

                        // ÂàõÂª∫ ul ÂÖÉÁ¥†
                        const ul = document.createElement('ul');

                        // ÈÅçÂéÜÊØè‰∏™Êñ∞ÈóªÈ°π
                        parsedContent[newsCategory].forEach(newsItem => {
                            const li = document.createElement('li');
                            const newsItemContent = JSON.parse(newsItem["content"])
                            li.innerText = newsItemContent.cnTitle + " ";

                            const memoID = newsItem["memo_id"];
                            li.setAttribute('post-item-id', newsItem["id"]); // TODO

                            // ÂàõÂª∫ÈìæÊé•
                            const link = document.createElement('a');
                            link.href = newsItemContent.link;
                            link.innerText = `${newsItemContent.title}`;
                            link.target = "_blank"; // Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄÈìæÊé•

                            li.appendChild(link);
                            li.append(" ");

                            const button = document.createElement('button');
                            button.innerText = "üíæ";
                            button.onclick = async function () {
                                const postItemID = li.getAttribute('post-item-id');
                                console.log("postItemID: " + postItemID);
                                const memoContent = `${newsItemContent.cnTitle}\n${newsItemContent.title}\n${newsItemContent.link}\n#rss`;

                                // ÂèëÈÄÅ POST ËØ∑Ê±ÇÂà∞ createMemo
                                const response = await fetch('/createMemo', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ postItemID: postItemID, memoContent: memoContent })
                                });

                                // Ê†πÊçÆËøîÂõûÁªìÊûúÊèêÁ§∫ÊàêÂäüÊàñÂ§±Ë¥•
                                const result = await response.json();
                                if (response.ok) {
                                    alert('Memo created successfully!');
                                    location.reload();
                                } else {
                                    alert('Failed to create memo: ' + result.error);
                                }
                            };

                            li.appendChild(button);
                            if (memoID) {
                                const emojiIcon = document.createElement('span');
                                emojiIcon.textContent = ' ‚úÖ';
                                li.appendChild(emojiIcon);
                            }
                            ul.appendChild(li);
                        });

                        newsContainer.appendChild(ul);
                    }

                    // Ê†áËÆ∞ post ‰∏∫Â∑≤ËØª
                    markPostAsRead(postId);
                })
                .catch(error => {
                    console.error('Error loading post:', error);
                    document.getElementById("loading").innerText = "‚ùå Error loading post!";
                });
        });

        function markPostAsRead(postId) {
            // Ë∞ÉÁî® markRead API Ê†áËÆ∞‰∏∫Â∑≤ËØª
            fetch('/mark_read', {
                method: 'POST',
                body: JSON.stringify({ post_id: postId })
            })
                .then(response => response.json())
                .catch(error => {
                    console.error('Error marking post as read:', error);
                });
        }

        function getPostIdFromUrl() {
            const url = window.location.href;
            const urlParams = new URLSearchParams(new URL(url).search);
            const id = urlParams.get('id');
            return id;
        }
    </script>
</body>

</html>