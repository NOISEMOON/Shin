<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox</title>
    <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
</head>

<body>
    <h1>
        <a href="/home">Home</a>
        <span> </span>
        <a href="/tools">Tools</a>
        <span> </span>
        <a href="https://3.r69202866.nyat.app:25030/" target="_blank">Memos</a>
    </h1>
    <div id="search-box">
        <input type="text" id="keyword" placeholder="Enter keyword">
        <button onclick="searchPosts(false)">Search</button>
    </div>
    <div>
        <button onclick="searchPosts(true)">Important</button>
    </div>

    <div id="post-list"></div>

    <div id="post-content" style="display: none;">
        <div id="news-container"></div>
    </div>

    <div id="pagination">
        <span id="page-info"></span> <!-- æ˜¾ç¤ºå½“å‰é¡µé¢å’Œæ€»é¡µç  -->
        <div>
            <a href="#" id="prev-link" style="display:none;">â† Previous</a>
            <a href="#" id="next-link" style="display:none;">Next â†’</a>
        </div>
    </div>

    <script>
        let currentPage = 1; // å½“å‰é¡µé¢
        let totalPages = 1; // æ€»é¡µç 

        async function loadPosts(pageNumber) {
            const response = await fetch(`/pagePost?page_number=${pageNumber}&page_size=10`, {
                method: 'GET'
            });
            const data = await response.json();
            const postList = document.getElementById('post-list');

            // æ¸…ç©ºåˆ—è¡¨
            postList.innerHTML = '';
            totalPages = data.total_page; // è·å–æ€»é¡µç 

            data.data.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';
                const linkClass = post.read_at !== "0" ? "read-link" : "unread-link"; // é€‰æ‹©ç±»å

                postDiv.innerHTML = `
                    ${post.read_at !== "0" ? " â—‰" : " â—‹"}
                    <a href="/detail?id=${post.id}" class="${linkClass}">${post.title}</a>
                `;
                postList.appendChild(postDiv);
            });

            // æ›´æ–°å½“å‰é¡µé¢ä¿¡æ¯
            document.getElementById('page-info').innerText = `Page ${pageNumber} of ${totalPages}`;

            // æ˜¾ç¤º/éšè—ç¿»é¡µé“¾æ¥
            document.getElementById('prev-link').style.display = pageNumber > 1 ? 'inline' : 'none';
            document.getElementById('next-link').style.display = pageNumber < totalPages ? 'inline' : 'none';
        }

        async function searchPosts(imp) {
            var response;
            if (imp) {
                response = await fetch(`/getImportant`);
            } else {
                const keyword = document.getElementById('keyword').value;
                response = await fetch(`/search?keyword=${encodeURIComponent(keyword)}`);
            }

            const result = await response.json();

            // è·å–æ–°é—»å®¹å™¨
            const newsContainer = document.getElementById('news-container');

            if (result.length === 0) {
                newsContainer.innerHTML = '<p>No results found</p>';
                return;
            }

            // åˆ›å»º ul å…ƒç´ 
            const ul = document.createElement('ul');

            // éå†æ¯ä¸ªæ–°é—»é¡¹
            result.forEach(newsItem => {
                const li = document.createElement('li');
                const newsItemContent = JSON.parse(newsItem["content"])
                li.innerText = newsItemContent.cnTitle + " ";

                const memoID = newsItem["memo_id"];
                li.setAttribute('post-item-id', newsItem["id"]); // TODO

                // åˆ›å»ºé“¾æ¥
                const link = document.createElement('a');
                link.href = newsItemContent.link;
                link.innerText = `${newsItemContent.title}`;
                link.target = "_blank"; // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é“¾æ¥

                li.appendChild(link);
                li.append(" ");

                const button = document.createElement('button');
                button.innerText = "ğŸ’¾";
                button.onclick = async function () {
                    const postItemID = li.getAttribute('post-item-id');
                    const memoContent = `${newsItemContent.cnTitle}\n${newsItemContent.title}\n${newsItemContent.link}\n#rss`;

                    // å‘é€ POST è¯·æ±‚åˆ° createMemo
                    const response = await fetch('/createMemo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ postItemID: postItemID, memoContent: memoContent })
                    });

                    // æ ¹æ®è¿”å›ç»“æœæç¤ºæˆåŠŸæˆ–å¤±è´¥
                    const result = await response.json();
                    if (response.ok) {
                        alert('Memo created successfully!');
                        location.reload();
                    } else {
                        alert('Failed to create memo: ' + result.error);
                    }
                };

                li.appendChild(button);
                if (memoID) {
                    const emojiIcon = document.createElement('span');
                    emojiIcon.textContent = ' âœ…';
                    li.appendChild(emojiIcon);
                }
                ul.appendChild(li);
            });

            newsContainer.appendChild(ul);
            document.getElementById('post-content').style.display = 'inline';
            document.getElementById('post-list').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        // ç‚¹å‡»å‘å‰ç¿»é¡µ
        document.getElementById('prev-link').addEventListener('click', (event) => {
            event.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º
            if (currentPage > 1) {
                currentPage--;
                loadPosts(currentPage);
            }
        });

        // ç‚¹å‡»å‘åç¿»é¡µ
        document.getElementById('next-link').addEventListener('click', (event) => {
            event.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º
            if (currentPage < totalPages) {
                currentPage++;
                loadPosts(currentPage);
            }
        });

        document.addEventListener("DOMContentLoaded", loadPosts(currentPage));
    </script>
</body>

</html>